@page "/calculator"
@using Rekenmachine.Components.Model

@rendermode InteractiveServer
<PageTitle>Calculator</PageTitle>

<h1>Calculator</h1>

<div class="card">
    <div class="card-body">
        <p role="status">@displayNumber</p>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-borderless">
        <tbody>
            <tr>
                <td>
                    <button class="btn btn-outline-primary" @onclick="ResetAll">All Clear</button>
                </td>
                <td>
                    <button class="btn btn-outline-primary" @onclick="NumpadPlusMinus">+/-</button>
                </td>
                <td>
                    <button class="btn btn-outline-primary" @onclick="NumpadPercentage">%</button>
                </td>
                <td>
                    <button class="btn btn-outline-warning @(stateActiveButton == Operation.Divide ? "active" : "")" @onclick=" NumPadDivide">/</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadSeven">7</button>
                </td>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadEight">8</button>
                </td>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadNine">9</button>
                </td>
                <td>
                    <button class="btn btn-outline-warning @(stateActiveButton == Operation.Multiply ? "active" : "")" @onclick="NumPadMultiply">x</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadFour">4</button>
                </td>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadFive">5</button>
                </td>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadSix">6</button>
                </td>
                <td>
                    <button class="btn btn-outline-warning @(stateActiveButton == Operation.Minus ? "active" : "")" @onclick="NumpadSubtraction">-</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadOne">1</button>
                </td>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadTwo">2</button>
                </td>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumPadTree">3</button>
                </td>
                <td>
                    <button class="btn btn-outline-warning @(stateActiveButton == Operation.Plus ? "active" : "")" @onclick="NumpadAddition">+</button>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <button class="btn btn-outline-secondary" @onclick="NumPadZero">0</button>
                </td>
                <td>
                    <button class="btn btn-outline-secondary" @onclick="NumpadComma">,</button>
                </td>
                <td>
                    <button class="btn btn-outline-warning @(stateActiveButton == Operation.Som ? "active" : "")" @onclick="NumpadSom">=</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>
@code {
    private bool isCommaOn = false;
    private bool isCalculationOn = false;
    private bool isPlusMinusOnFirst = false;
    private bool isPlusMinusOnSecond = false;

    private string displayNumber = "0";
    private string tempInputNmber = string.Empty;

    private Model.NumpadConfiguration first = new Model.NumpadConfiguration { InputNumber = 0 };
    private Model.NumpadConfiguration second = new Model.NumpadConfiguration { InputNumber = 0 };
    private Model.Calculator calculator = new Model.Calculator();

    private string plusMinusFirstInput = "";
    private string plusMinusSecondInput = "";

    private Operation stateCalculation = Operation.None;
    private Operation stateActiveButton = Operation.None;

    private enum Operation
    {
        Divide,
        Multiply,
        Minus,
        Plus,
        Som,
        None
    }

    private void ResetAll()
    {
        displayNumber = "0";
        tempInputNmber = string.Empty;

        first = new Model.NumpadConfiguration { InputNumber = 0 };
        second = new Model.NumpadConfiguration { InputNumber = 0 };

        plusMinusFirstInput = "";
        plusMinusSecondInput = "";
        isCommaOn = false;
        isCalculationOn = false;
        isPlusMinusOnFirst = false;
        isPlusMinusOnSecond = false;

        stateCalculation = Operation.None;
        stateActiveButton = Operation.None;
    }

    /* Flag for comma when it's pressed */
    private void NumpadComma()
    {
        isCommaOn = true;
    }

    /* The minus sign will be toggled on and off based on for first input number and second input number */
    private void NumpadPlusMinus()
    {
        plusMinusFirstInput = "";
        plusMinusSecondInput = "";

        if (!isCalculationOn)
        {
            isPlusMinusOnFirst = !isPlusMinusOnFirst;
            displayNumber = first.TogglePlusAndMinus(isPlusMinusOnFirst, plusMinusFirstInput);
        }
        else
        {
            isPlusMinusOnSecond = !isPlusMinusOnSecond;
            displayNumber = second.TogglePlusAndMinus(isPlusMinusOnSecond, plusMinusSecondInput);
        }
    }

    /* Calculate the percentage of the number. */
    private void NumpadPercentage()
    {
        //Forcing to use comma with decimal
        CultureInfo culture = new CultureInfo("nl-NL");

        if (!isCalculationOn)
        {
            decimal firstNumberInPercentage = calculator.Percentage(first.InputNumber);

            // new value
            first.InputNumber = firstNumberInPercentage;
            first.DisplayNumber = firstNumberInPercentage.ToString(culture);

            // update display number
            displayNumber = firstNumberInPercentage.ToString(culture);
        }
        else
        {
            decimal secondNumberInPercentage = calculator.Percentage(second.InputNumber);

            // new value
            second.InputNumber = secondNumberInPercentage;
            second.DisplayNumber = secondNumberInPercentage.ToString(culture);

            // update display number
            displayNumber = secondNumberInPercentage.ToString(culture);
        }
    }

    /* Toggle the calculation buttons of multiply, divide, minus and plus. */
    private void ToggleCalculationActiveState(Operation changeState)
    {
        stateCalculation = changeState;
        if (stateActiveButton != Operation.None)
        {
            stateActiveButton = Operation.None;
        }
        else
        {
            stateActiveButton = stateCalculation;
        }
    }

    /* This will hold isCalculation is true when divide is clicked. Reset the state isCommaOn to false. */
    private void NumPadDivide()
    {
        isCalculationOn = true;
        isCommaOn = false;
        ToggleCalculationActiveState(Operation.Divide);
    }

    /* This will hold isCalculation is true when multiply is clicked. Reset the state isCommaOn to false. */
    private void NumPadMultiply()
    {
        isCalculationOn = true;
        isCommaOn = false;
        ToggleCalculationActiveState(Operation.Multiply);
    }

    /* This will hold isCalculation is true when minus is clicked. Reset the state isCommaOn to false. */
    private void NumpadSubtraction()
    {
        isCalculationOn = true;
        isCommaOn = false;
        ToggleCalculationActiveState(Operation.Minus);
    }

    /* This will hold isCalculation is true when plus is clicked. Reset the state isCommaOn to false. */
    private void NumpadAddition()
    {
        isCalculationOn = true;
        isCommaOn = false;
        ToggleCalculationActiveState(Operation.Plus);
    }

    /* Input data is in string and need to convert to decimal for calculation.
    * The calculation are Divide, Multiply, Minus and Plus */
    private void NumpadSom()
    {
        decimal resultCalculation = 0;

        switch (stateCalculation)
        {
            case Operation.Divide:
                resultCalculation = calculator.CalculateDivision(first.InputNumber, second.InputNumber);
                break;
            case Operation.Multiply:
                resultCalculation = calculator.CalculateMultiplication(first.InputNumber, second.InputNumber);
                break;
            case Operation.Minus:
                resultCalculation = calculator.CalculateSubtraction(first.InputNumber, second.InputNumber);
                break;
            case Operation.Plus:
                resultCalculation = calculator.CalculateAddition(first.InputNumber, second.InputNumber);
                break;

        }
        displayNumber = resultCalculation.ToString();
        ToggleCalculationActiveState(Operation.Som);
        isCalculationOn = false;
    }

    private void NumPadZero()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(0, "0", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(0, "0", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadOne()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(1, "1", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(1, "1", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadTwo()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(2, "2", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(2, "2", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadTree()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(3, "3", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(3, "3", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadFour()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(4, "4", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(4, "4", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadFive()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(5, "5", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(5, "5", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadSix()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(6, "6", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(6, "6", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadSeven()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(7, "7", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(7, "7", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadEight()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(8, "8", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(8, "8", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

    private void NumPadNine()
    {
        tempInputNmber = string.Empty;

        if (!isCalculationOn)
        {
            first.CollectNumber(9, "9", isCommaOn);
            tempInputNmber = first.DisplayNumber;
        }
        else
        {
            second.CollectNumber(9, "9", isCommaOn);
            tempInputNmber = second.DisplayNumber;
        }

        // update display number
        displayNumber = tempInputNmber;
    }

}
